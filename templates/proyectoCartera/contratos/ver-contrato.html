{% extends "proyectoCartera/base.html" %}
{% load static %}

{% block title %}Contrato{% endblock %}

{% block body %}
    <div class="conteiner">
        <div class="row justify-content-center">
            <div class="card shadow-lg o-hidden border-0 my-1">
                <div class="card-body">
                    <div class="row d-flex justify-content-center my-0" style="margin: 50px;">
                        <div class="row p-3">
                            <div class="col p-3">
                                <fieldset class="border  border-2 border-dark  p-4">
                                    <legend class="fw-bold">Informacion Contrato :</legend>
                                    <div class="row row-cols-3">
                                        <div class="col fs-6">
                                            <span class="fw-bold"> # Contrato : </span> {{ informacion_contrato.numero_contrato }}
                                        </div>
                                        <div class="col fs-6">
                                            <span class="fw-bold"> Asesor : </span> {{ informacion_contrato.asesor }}
                                        </div>
                                        <div class="col fs-6">
                                            <span class="fw-bold"> Cliente : </span> {{ informacion_contrato.cliente }}
                                        </div>
                                        <div class="col fs-6">
                                            <span class="fw-bold"> Valor inicial : </span> {{ informacion_contrato.valor }}
                                            (COP)
                                        </div>
                                        <div class="col fs-6">
                                            <span class="fw-bold"> Fecha inicial : </span> {{ informacion_contrato.fecha_inicial }}
                                        </div>
                                        <div class="col fs-6">
                                            <span class="fw-bold"> Fecha final : </span> {{ informacion_contrato.fecha_final }}
                                        </div>
                                        <div class="col fs-6">
                                            <span class="fw-bold"> Valor sub-contratos : </span> {{ informacion_contrato.valor_subcontratos }}
                                            (COP)
                                        </div>
                                        <div class="col fs-6">
                                            <span class="fw-bold"> Valor total : </span> {{ informacion_pagos.4 }} (COP)
                                        </div>
                                        <div class="col fs-6">
                                            <span class="fw-bold"> Saldo : </span> {{ informacion_pagos.2 }} (COP)
                                        </div>
                                        <div class="col fs-6">
                                            <span class="fw-bold"> Pagos realizados : </span> {{ informacion_pagos.1 }}
                                            (COP)
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                    </div>
                    <div class="col p-3">
                        <fieldset class="border  border-2 border-dark  p-4">
                            <legend class="fw-bold">Pagos Realizados</legend>
                            <div class="table-responsive p-3 text-center">
                                <table id="tabla_pagos"
                                       class="display compact cell-border table-bordered table-striped mx-auto"></table>
                            </div>
                            <div class="row m-3">
                                {% if informacion_pagos.5 > 0 %}
                                    <a href='{% url 'carteraApp_agregar_pago' informacion_contrato.numero_contrato %}' class="btn btn-primary">Realizar
                                        pago</a>
                                {% else %}
                                    <button class="btn btn-primary" disabled>Realizar pago</button>
                                {% endif %}

                            </div>
                        </fieldset>
                    </div>
                    <div class="col p-3">
                        <fieldset class="border  border-2 border-dark  p-4">
                            <legend class="fw-bold">Sub-Contratos Realizados</legend>
                            <div class="table-responsive p-3 text-center">
                                <table id="tabla_subcontratos"
                                       class="display compact cell-border table-bordered table-striped mx-auto"></table>
                            </div>
                            <div class="row m-3">
                                <a href="{% url 'carteraApp_agregar_subcontrato' informacion_contrato.numero_contrato %}"
                                   class="btn btn-primary"> Agregar sub-contrato</a>
                            </div>
                        </fieldset>
                    </div>
                </div>
            </div>
        </div>

    </div>
    {% if messages %}
        {% for mensaje in messages %}
            <script>
                Swal.fire({
                    "title": "{{ mensaje }}",
                    "icon": "success"
                })
            </script>
        {% endfor %}
    {% endif %}




    <script>
        //tabla pagos
        $(document).ready(function () {
            $('#tabla_pagos').DataTable({
                pageLength: 5,
                responsive: true,
                serverSide: true,
                processing: true,
                searching: true,
                ajax: '{% url "carteraApp_pagos_data" informacion_contrato.numero_contrato %}',
                language: {
                    "url": "//cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json"
                },
                columns: [
                    {data: 'contrato', title: '# Contrato'},
                    {data: 'tipo_pago', title: 'Tipo de pago'},
                    {data: 'valor_pago', title: 'Valor del pago (COP)'},
                    {data: 'fecha_pago', title: 'Fecha del pago'},
                    {
                        data: 'archivo_pago', title: 'Archivo Pago',
                        render: function (data, type, row, meta) {
                            if (data) {
                                return '<a href="' + data + '" target="_blank"><img src="{% static 'img/file-earmark-minus.svg' %}" class="bi d-block mx-auto mb-1" width="24" height="24"></a>';
                            } else {
                                return data
                            }
                        }
                    },
                    {
                        data: null, title: 'Opciones',
                        render: function (data, type, row, meta) {
                            return '<button class="btn btn-info" onclick=" editarPago(' + row.id + ')">Editar</button> ';
                        }
                    }
                ]
            });
        });

        function editarPago(contratoId) {
            window.location.href = '{% url 'carteraApp_editar_pago' 'numero_contrato' %}'.replace('numero_contrato', contratoId)
        }

        //fin tabla pagos

        //tabla subcontratos

        $(document).ready(function () {
            $('#tabla_subcontratos').DataTable({
                pageLength: 5,
                responsive: true,
                serverSide: true,
                processing: true,
                searching: true,
                ajax: '{% url "carteraApp_subcontratos_data" informacion_contrato.numero_contrato %}',
                language: {
                    "url": "//cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json"
                },
                columns: [
                    {data: 'contrato', title: '# Contrato'},
                    {data: 'nuevo_valor', title: 'Valor (COP)'},
                    {data: 'nueva_fecha', title: 'Fecha'},
                    {
                        data: 'archivo_nuevo', title: 'Archivo contrato',
                        render: function (data, type, row, meta) {
                            if (data) {
                                return '<a href="' + data + '" target="_blank"><img src="{% static 'img/file-earmark-minus.svg' %}" class="bi d-block mx-auto mb-1" width="24" height="24"></a>';
                            } else {
                                return data
                            }
                        }
                    },
                ]
            });
        });


        //fin tablasubcontratos
    </script>

{% endblock %}